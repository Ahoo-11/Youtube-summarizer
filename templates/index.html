<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Summary Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" onclick="showDashboard()" class="active" data-view="home">Home</a></li>
                <li><a href="#" onclick="showAllArchives()" data-view="all">All Archives</a></li>
            </ul>
            <div class="custom-folders">
                <h3>Custom Folders</h3>
                <div class="folder-list" id="folderList"></div>
                <button class="add-folder-btn" onclick="createNewFolder()">
                    <i class="fas fa-plus"></i> New Folder
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Dashboard -->
            <div id="homeDashboard" class="dashboard-container">
                <div class="container">
                    <h1>YouTube Summary Tool <button class="theme-toggle" onclick="toggleTheme()">üåô</button></h1>
                    
                    <div class="input-section">
                        <input type="text" id="youtubeUrl" placeholder="Enter YouTube URL" class="url-input" onkeypress="handleEnterKey(event)">
                        <button id="generateBtn" onclick="generateSummary()" class="generate-btn">
                            <i class="fas fa-magic"></i> Generate Summary
                        </button>
                    </div>

                    <div id="result" class="result-section"></div>
                </div>
            </div>

            <!-- Archives View -->
            <div id="archivesView" class="archives-container" style="display: none;">
                <div class="container">
                    <h1>Archives <button class="theme-toggle" onclick="toggleTheme()">üåô</button></h1>
                    
                    <!-- Search and Filter Section -->
                    <div class="search-filter-section">
                        <input type="text" class="search-input" placeholder="Search archives..." oninput="filterArchives()">
                        <button class="view-toggle" onclick="toggleView()">
                            <i class="fas fa-grid"></i>
                        </button>
                    </div>

                    <!-- Actions Bar -->
                    <div class="actions-bar">
                        <div class="select-all">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label for="selectAll">Select All</label>
                        </div>
                        <div class="action-buttons">
                            <button class="download-btn" onclick="downloadSelected()" disabled>
                                <i class="fas fa-download"></i> Download Selected
                            </button>
                            <button class="delete-btn" onclick="deleteSelected()" disabled>
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                        </div>
                    </div>

                    <!-- Archives Grid/List -->
                    <div id="archivesList" class="grid-view"></div>
                </div>
            </div>

            <!-- Add new Single Archive View container -->
            <div id="singleArchiveView" class="single-archive-view" style="display: none;">
                <div class="container">
                    <div class="back-button">
                        <button onclick="showAllArchives()">
                            <i class="fas fa-arrow-left"></i> Back to Archives
                        </button>
                    </div>
                    <div id="singleArchiveContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentView = 'grid';
        let selectedArchives = new Set();
        let customFolders = new Map();

        // View Management
        function showDashboard() {
            document.getElementById('homeDashboard').style.display = 'block';
            document.getElementById('archivesView').style.display = 'none';
            document.getElementById('singleArchiveView').style.display = 'none';
            document.getElementById('result').innerHTML = '';
            updateActiveNav('home');
        }

        function showAllArchives() {
            document.getElementById('homeDashboard').style.display = 'none';
            document.getElementById('archivesView').style.display = 'block';
            document.getElementById('singleArchiveView').style.display = 'none';
            updateActiveNav('all');
            displayArchives();
        }

        function updateActiveNav(view) {
            document.querySelectorAll('.sidebar-menu a').forEach(a => {
                a.classList.remove('active');
                if (a.dataset.view === view) a.classList.add('active');
            });
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const themeButtons = document.querySelectorAll('.theme-toggle');
            themeButtons.forEach(button => {
                button.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            });
        }

        // Modal Management
        function showSingleArchive(archive) {
            document.getElementById('homeDashboard').style.display = 'none';
            document.getElementById('archivesView').style.display = 'none';
            
            const singleArchiveView = document.getElementById('singleArchiveView');
            const singleArchiveContent = document.getElementById('singleArchiveContent');
            
            singleArchiveContent.innerHTML = `
                <div class="single-archive-header">
                    <h1>${archive.title}</h1>
                    <img src="${archive.thumbnail}" alt="Video thumbnail" class="full-thumbnail">
                    <div class="archive-metadata">
                        <span>${archive.date}</span>
                        <a href="${archive.url}" target="_blank" class="video-link">
                            <i class="fab fa-youtube"></i> Watch on YouTube
                        </a>
                    </div>
                </div>
                <div class="single-archive-summary">
                    <div class="summary-header">
                        <h2>Summary</h2>
                        <button class="edit-btn" onclick="toggleEdit(this, '${generateArchiveId(archive.url, archive.date)}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="summary-content markdown-content" id="summary-${generateArchiveId(archive.url, archive.date)}" contenteditable="false">
                        ${marked.parse(archive.summary)}
                    </div>
                    <div class="edit-actions" style="display: none;">
                        <button class="save-btn" onclick="saveSummaryEdit('${generateArchiveId(archive.url, archive.date)}')">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button class="cancel-btn" onclick="cancelEdit('${generateArchiveId(archive.url, archive.date)}')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            singleArchiveView.style.display = 'block';
        }

        // View toggle
        function toggleView() {
            const archivesList = document.getElementById('archivesList');
            currentView = currentView === 'grid' ? 'list' : 'grid';
            archivesList.className = `${currentView}-view`;
            
            const viewToggle = document.querySelector('.view-toggle i');
            viewToggle.className = currentView === 'grid' ? 'fas fa-list' : 'fas fa-grid';
            
            displayArchives();
        }

        // Get displayed archives
        function getDisplayedArchives() {
            const archives = JSON.parse(localStorage.getItem('summaryHistory') || '[]');
            console.log('Retrieved archives:', archives); // Debug log
            return archives;
        }

        // Generate a unique ID for each archive
        function generateArchiveId(url, date) {
            return `${url}-${date}`.replace(/[^a-zA-Z0-9]/g, '-');
        }

        // Display archives function update
        function displayArchives(archivesList = null) {
            const archives = archivesList || getDisplayedArchives();
            const archivesContainer = document.getElementById('archivesList');
            
            if (archives.length === 0) {
                archivesContainer.innerHTML = '<div class="no-archives">No summaries yet. Generate some summaries to see them here!</div>';
                updateDownloadButtonState();
                return;
            }

            archivesContainer.innerHTML = archives.map(archive => {
                const archiveId = generateArchiveId(archive.url, archive.date);
                return `
                    <div class="archive-card">
                        <div class="archive-select">
                            <label class="checkbox-container">
                                <input type="checkbox" 
                                       class="archive-checkbox" 
                                       data-archive-id="${archiveId}"
                                       ${selectedArchives.has(archiveId) ? 'checked' : ''}
                                       onchange="toggleArchiveSelection('${archiveId}')">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="archive-preview" onclick="showSingleArchive(${JSON.stringify(archive).replace(/"/g, '&quot;')})">
                            <img src="${archive.thumbnail}" alt="Video thumbnail" class="video-thumbnail">
                            <div class="archive-info">
                                <h3>${archive.title}</h3>
                                <span class="date">${archive.date}</span>
                                <div class="summary-preview markdown-content">${marked.parse(archive.summary.substring(0, 150) + '...')}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateDownloadButtonState();
        }

        // Download selected archives
        function downloadSelected() {
            const archives = getDisplayedArchives();
            const selectedContent = archives
                .filter(archive => {
                    const archiveId = generateArchiveId(archive.url, archive.date);
                    return selectedArchives.has(archiveId);
                })
                .map(archive => {
                    return `Title: ${archive.title}
Date: ${archive.date}
URL: ${archive.url}

Summary:
${archive.summary}

----------------------------------------
`;
                })
                .join('\n');

            if (selectedContent) {
                const blob = new Blob([selectedContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `youtube-summaries-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        // Update download button state
        function updateDownloadButtonState() {
            updateActionButtonsState();
        }

        // Toggle individual archive selection
        function toggleArchiveSelection(archiveId) {
            console.log('Toggling archive:', archiveId); // Debug log
            if (selectedArchives.has(archiveId)) {
                selectedArchives.delete(archiveId);
            } else {
                selectedArchives.add(archiveId);
            }
            updateDownloadButtonState();
        }

        // Toggle select all function
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.archive-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            checkboxes.forEach(checkbox => {
                const archiveId = checkbox.dataset.archiveId;
                if (selectAllCheckbox.checked) {
                    selectedArchives.add(archiveId);
                    checkbox.checked = true;
                } else {
                    selectedArchives.delete(archiveId);
                    checkbox.checked = false;
                }
            });
            
            updateDownloadButtonState();
        }

        // Handle Enter key
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                generateSummary();
            }
        }

        // Generate summary function
        async function generateSummary() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const resultDiv = document.getElementById('result');
            const generateBtn = document.getElementById('generateBtn');
            
            // Clear previous results
            resultDiv.innerHTML = '';
            
            if (!url) {
                resultDiv.innerHTML = '<div class="error">Please enter a YouTube URL</div>';
                return;
            }

            try {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                
                const response = await fetch('/summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                // Show only the current generated summary
                resultDiv.innerHTML = `
                    <div class="video-preview">
                        <img src="${data.thumbnail}" alt="Video thumbnail" class="thumbnail">
                        <div class="preview-content">
                            <h2>${data.title}</h2>
                            <div class="summary-content markdown-content">${marked.parse(data.summary)}</div>
                        </div>
                    </div>
                `;

                // Save to history
                const historyItem = {
                    videoId: data.videoId,
                    url: url,
                    title: data.title,
                    summary: data.summary,
                    thumbnail: data.thumbnail,
                    date: new Date().toLocaleDateString()
                };

                // Get existing history and update
                let history = JSON.parse(localStorage.getItem('summaryHistory') || '[]');
                history.unshift(historyItem);
                localStorage.setItem('summaryHistory', JSON.stringify(history));

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Summary';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadFolders();
            showDashboard();
            selectedArchives = new Set();
            updateDownloadButtonState();
        });

        // Existing functions (createNewFolder, updateFolderList, etc.) remain the same...
        
        // Add this new function for deleting selected archives
        function deleteSelected() {
            if (!confirm('Are you sure you want to delete the selected archives? This action cannot be undone.')) {
                return;
            }

            const archives = getDisplayedArchives();
            const updatedArchives = archives.filter(archive => {
                const archiveId = generateArchiveId(archive.url, archive.date);
                return !selectedArchives.has(archiveId);
            });

            // Update localStorage with filtered archives
            localStorage.setItem('summaryHistory', JSON.stringify(updatedArchives));
            
            // Clear selected archives
            selectedArchives.clear();
            
            // Update UI
            displayArchives();
            updateActionButtonsState();
        }

        // New function to update both action buttons
        function updateActionButtonsState() {
            const downloadBtn = document.querySelector('.download-btn');
            const deleteBtn = document.querySelector('.delete-btn');
            const hasSelections = selectedArchives.size > 0;
            
            if (downloadBtn) {
                downloadBtn.disabled = !hasSelections;
            }
            if (deleteBtn) {
                deleteBtn.disabled = !hasSelections;
            }
        }

        // Add these new functions for edit functionality
        function toggleEdit(button, archiveId) {
            const summaryDiv = document.getElementById(`summary-${archiveId}`);
            const editActions = button.parentElement.parentElement.querySelector('.edit-actions');
            
            if (button.querySelector('i').classList.contains('fa-edit')) {
                // Switch to edit mode
                summaryDiv.contentEditable = true;
                summaryDiv.focus();
                summaryDiv.classList.add('editing');
                button.innerHTML = '<i class="fas fa-times"></i> Cancel';
                editActions.style.display = 'flex';
                
                // Add event listener for paste to handle plain text
                summaryDiv.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text/plain');
                    document.execCommand('insertText', false, text);
                });
                
                // Add event listener for keydown to handle tab key
                summaryDiv.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        document.execCommand('insertText', false, '    ');
                    }
                });
            } else {
                // Cancel edit
                cancelEdit(archiveId);
            }
        }

        function getOriginalContent(archiveId) {
            const archives = JSON.parse(localStorage.getItem('summaryHistory') || '[]');
            const archive = archives.find(a => generateArchiveId(a.url, a.date) === archiveId);
            return archive ? archive.summary : '';
        }

        function saveSummaryEdit(archiveId) {
            const summaryDiv = document.getElementById(`summary-${archiveId}`);
            // Get the HTML content and convert markdown-like formatting back to markdown
            let newContent = summaryDiv.innerHTML
                .replace(/<h1>/g, '# ')
                .replace(/<\/h1>/g, '\n')
                .replace(/<h2>/g, '## ')
                .replace(/<\/h2>/g, '\n')
                .replace(/<h3>/g, '### ')
                .replace(/<\/h3>/g, '\n')
                .replace(/<h4>/g, '#### ')
                .replace(/<\/h4>/g, '\n')
                .replace(/<p>/g, '')
                .replace(/<\/p>/g, '\n')
                .replace(/<strong>/g, '**')
                .replace(/<\/strong>/g, '**')
                .replace(/<em>/g, '*')
                .replace(/<\/em>/g, '*')
                .replace(/<ul>/g, '')
                .replace(/<\/ul>/g, '\n')
                .replace(/<ol>/g, '')
                .replace(/<\/ol>/g, '\n')
                .replace(/<li>/g, '* ')
                .replace(/<\/li>/g, '\n')
                .replace(/<code>/g, '`')
                .replace(/<\/code>/g, '`')
                .replace(/<pre>/g, '```\n')
                .replace(/<\/pre>/g, '\n```')
                .replace(/<blockquote>/g, '> ')
                .replace(/<\/blockquote>/g, '\n')
                .replace(/&nbsp;/g, ' ')
                .replace(/&gt;/g, '>')
                .replace(/&lt;/g, '<')
                .replace(/&amp;/g, '&')
                .replace(/<br>/g, '\n')
                .replace(/<div>/g, '')
                .replace(/<\/div>/g, '\n')
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                .trim();
            
            const editButton = summaryDiv.parentElement.querySelector('.edit-btn');
            const editActions = summaryDiv.parentElement.querySelector('.edit-actions');
            
            // Update localStorage
            const archives = JSON.parse(localStorage.getItem('summaryHistory') || '[]');
            const archiveIndex = archives.findIndex(a => generateArchiveId(a.url, a.date) === archiveId);
            
            if (archiveIndex !== -1) {
                archives[archiveIndex].summary = newContent;
                localStorage.setItem('summaryHistory', JSON.stringify(archives));
                
                // Update display
                summaryDiv.innerHTML = marked.parse(newContent);
                summaryDiv.contentEditable = false;
                summaryDiv.classList.remove('editing');
                editButton.innerHTML = '<i class="fas fa-edit"></i> Edit';
                editActions.style.display = 'none';
            }
        }

        function cancelEdit(archiveId) {
            const summaryDiv = document.getElementById(`summary-${archiveId}`);
            const editButton = summaryDiv.parentElement.querySelector('.edit-btn');
            const editActions = summaryDiv.parentElement.querySelector('.edit-actions');
            
            // Restore original content
            const originalContent = getOriginalContent(archiveId);
            summaryDiv.innerHTML = marked.parse(originalContent);
            summaryDiv.contentEditable = false;
            summaryDiv.classList.remove('editing');
            editButton.innerHTML = '<i class="fas fa-edit"></i> Edit';
            editActions.style.display = 'none';
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
